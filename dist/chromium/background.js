"use strict";(()=>{var c="https://www.bing.com/",T="https://cn.bing.com/",x="https://chat.aiplus.lol/login",I=["zh-CN","ru","ru-ru"];var A=["csp_report","font","image","main_frame","media","object","other","ping","script","stylesheet","sub_frame","webbundle","websocket","webtransport","xmlhttprequest"];var v="2.7.3";var d={type:"git",url:"https://github.com/ha0z1/New-Bing-Anywhere"};var G=()=>{try{return chrome.i18n.getUILanguage().toLowerCase()==="zh-cn"}catch{return!1}},W=()=>{try{let e=chrome.i18n.getUILanguage().toLowerCase();return e==="zh-cn"||e==="zh-tw"||e==="zh-hk"||e==="zh"}catch{return!1}};var B="configV1",C=async()=>({showGoogleButtonOnBing:!0,showBingButtonOnGoogle:!0,showGuideToGithub:!0,showChat:!1,showRelease:!1,triggerMode:"Always",conversationStyle:"Balanced","X-Forwarded-For":void 0,...(await chrome.storage.sync.get(B))[B]});var P=e=>{chrome.runtime.onMessage.addListener((o,t,n)=>((async()=>{try{let{method:s,args:r}=o,i=await e[s](...r);n({code:200,msg:"ok",data:i})}catch(s){let r=s??{};n({code:500,msg:r.stack??r.message??s})}})(),!0))};var se=navigator.userAgent,F=navigator.userAgentData;var ae=F?.brands.findIndex(e=>e.brand==="Brave")>-1,k=W(),E=G(),w=!!globalThis.__NBA_isCanary,u=w?`0.${v}`:v;var L=async e=>{let o=d.url;try{let t=await C(),s=`${o}/issues/new?title=&body=`,r="Please write your comment ABOVE this line, provide as much detailed information and screenshots as possible.Please confirm that you have read the #8 https://github.com/ha0z1/New-Bing-Anywhere/issues/8.The UA may not necessarily reflect your actual browser and platform, so please make sure to indicate them clearly.";k&&(r="\u8BF7\u5728\u6B64\u884C\u4E0A\u65B9\u53D1\u8868\u60A8\u7684\u8BA8\u8BBA\u3002\u8BF7\u786E\u8BA4\u5DF2\u7ECF\u9605\u8BFB\u4E86FAQ(https://github.com/ha0z1/New-Bing-Anywhere/issues/8)\uFF0C\u8BE6\u5C3D\u7684\u63CF\u8FF0\u548C\u622A\u56FE\u6709\u52A9\u4E8E\u6211\u4EEC\u5B9A\u4F4D\u95EE\u9898\uFF0C\u63CF\u8FF0\u4E0D\u6E05\u7684\u95EE\u9898\u4F1A\u88AB\u5173\u95ED\uFF0CUA \u4E0D\u4E00\u5B9A\u771F\u5B9E\u53CD\u6620\u60A8\u7684\u6D4F\u89C8\u5668\u548C\u5E73\u53F0\uFF0C\u8BF7\u5907\u6CE8\u6E05\u695A");let i=` 



<!--  ${r} -->
<pre>
`+Object.entries({Version:`${u}${w?" (Canary)":""} `,UA:navigator.userAgent,Lang:chrome.i18n.getUILanguage(),AcceptLangs:(await chrome.i18n.getAcceptLanguages()).join(", "),config:JSON.stringify(t),...e}).map(([h,m])=>m?`${h}: ${m}`:"").join(`
`)+"</pre>";return s+=encodeURIComponent(i.slice(0,2e3)),s}catch{return o}},g=(e="",o)=>{try{return new URL(e,o)}catch{return{searchParams:{get:()=>null}}}},y=e=>{try{return new URLSearchParams(e)}catch{return{get:()=>null}}},a=async e=>{let o=await chrome.tabs.query({currentWindow:!0}),t=g(e),n=o.find(s=>s.url?.startsWith(t.origin));return n==null?n=await chrome.tabs.create({url:e}):await Promise.all([chrome.tabs.move(n.id,{index:o.length-1}),n.url!==e&&chrome.tabs.update(n.id,{url:e}),chrome.tabs.update(n.id,{active:!0,url:n.url!==e?e:void 0})].filter(Boolean)),n};var f={openCopilot:{emoji:"\u{1F697}",icon:chrome.runtime.getURL("images/copilot.png"),title:"Copilot",contexts:["action"],onclick:e=>{a("https://copilot.microsoft.com/")}},openChat:{emoji:"\u{1F4AC}",icon:chrome.runtime.getURL("images/bing-chat.png"),title:"New Bing",contexts:["action"],onclick:e=>{a("https://www.bing.com/search?q=Bing+AI&showconv=1")}},openImageCreate:{emoji:"\u{1F5BC}\uFE0F",icon:chrome.runtime.getURL("images/designer.svg"),title:"New Bing Image Creator",contexts:["action"],onclick:e=>{a("https://www.bing.com/create")}},likeIt:{emoji:"\u2764\uFE0F",icon:chrome.runtime.getURL("images/like.png"),title:"Like it",contexts:["action"],onclick:()=>{a("https://chrome.google.com/webstore/detail/new-bing-anywhere-bing-ch/hceobhjokpdbogjkplmfjeomkeckkngi/reviews?hl=en")}},reportIssues:{emoji:"\u{1F41B}",icon:chrome.runtime.getURL("images/bugs.png"),title:"Report issues",contexts:["action"],onclick:async e=>{let o=await L();a(o)}}};var U=()=>{chrome.contextMenus.removeAll(()=>{for(let[e,o]of Object.entries(f))chrome.contextMenus.create({id:e,title:`${o.emoji} ${o.title}`,contexts:o.contexts})}),chrome.contextMenus.onClicked.addListener((e,o)=>{let{menuItemId:t}=e,n=f[t];n?.onclick&&n.onclick(e,o)})};var R={};var _=async e=>await new Promise((o,t)=>{let n=R[e];if(n==null)throw new Error(`WebSocket ${e} not found`);n.send(JSON.stringify({type:6})+""),o(null)});var O=async e=>{R[e]?.close(),R[e]=null};var l="notification",b="notification:hide",Y=async()=>{let e;try{e=await fetch("https://api.github.com/repos/ha0z1/New-Bing-Anywhere/issues/24").then(async o=>await o.json())}catch{}return e},D=async()=>{let{[l]:e}=await chrome.storage.local.get(l);if(!e||e.lastModify&&Date.now()-e.lastModify>36e5){await chrome.storage.local.remove(l);let n=await Y();n&&await chrome.storage.local.set({[l]:{data:n,lastModify:Date.now()}})}let{[b]:o,[l]:t}=await chrome.storage.local.get([b,l]);return!t?.data||!(t.data.title&&t.data.state==="open")||o===1&&t.data.title===e.data?.title?null:(await chrome.storage.local.remove(b),t.data)},M=async()=>{chrome.storage.local.set({[b]:1})};var K=async()=>({version:u}),H=async({url:e}={})=>{let o=await chrome.tabs.query({currentWindow:!0}),t=g(e),n=o.find(q=>q.url?.startsWith(t.origin));n==null?n=await chrome.tabs.create({url:e}):n.id!=null&&await Promise.all([chrome.tabs.move(n.id,{index:o.length-1}),chrome.tabs.update(n.id,{active:!0})]);let s=e,r="",i="",h=t.hostname==="www.google.com",m=t.hostname==="www.bing.com";h?(r=t.searchParams.get("q")??"",i=g(n.url).searchParams.get("q")??"",g(n.url).searchParams.get("q")):m&&(r=t.searchParams.get("q")??"",i=g(n.url).searchParams.get("q")??""),r=r.trim(),i=i.trim(),!(r&&r===i)&&(h?s=`${t.origin}${t.pathname}?q=${encodeURIComponent(r)}`:m&&(s=`${t.origin}${t.pathname}?q=${encodeURIComponent(r)}`),await chrome.tabs.update(n.id,{url:s}))},j={getEnv:K,openUrlInSameTab:H,getNotification:D,hideNotification:M,"bing.bingChatPing":_,"bing.bingChatCloseWebSocket":O};var p=async(e,o={})=>await chrome.cookies.set({domain:o.domain,storeId:o.storeId,path:o.path,httpOnly:o.httpOnly,secure:o.secure,sameSite:o.sameSite,expirationDate:o.expirationDate,...e});var $=()=>{U(),P(j),chrome.runtime.onInstalled.addListener(async e=>{let o=await C(),t=d.url;if(w){a(`${t}/tree/canary`);return}e.reason==="install"?a(t):e.reason==="update"&&o.showRelease&&a(`${t}/releases/tag/v${u}`)}),chrome.webRequest.onBeforeRequest.addListener(()=>{chrome.cookies.get({name:"_EDGE_S",url:c},e=>{let o=e?.value;if(!o)return;let t=y(o),n=t.get("mkt")?.toLowerCase()??"";I.map(s=>s.toLowerCase()).includes(n)&&(n==="zh-cn"?(t.set("mkt","zh-HK"),t.set("ui","zh-hans")):t.delete("mkt"),p({url:c,name:e.name,value:t.toString()},e))}),chrome.cookies.get({name:"_RwBf",url:c},e=>{let o=e?.value;if(!o){p({url:c,name:"_RwBf",value:"wls=2",domain:".bing.com",httpOnly:!0});return}let t=y(o),n=t.get("wls");n!=="2"&&n!==""&&t.set("wls","2"),p({url:c,name:"_RwBf",domain:".bing.com",httpOnly:!0,value:t.toString()},e)}),chrome.cookies.get({name:"ANON",url:c},e=>{let o=e?.value;if(!o)return;let t=y(o);t.delete("A"),p({url:c,name:"ANON",domain:".bing.com",httpOnly:!0,value:t.toString()},e)})},{urls:[c+"*"],types:["main_frame"]})};var V="redirect";var N=[k&&[{action:{type:V,redirect:{url:`${x}?invite_code=b90e84b5`}},condition:{requestDomains:["chat.aiplus.lol"],urlFilter:x,isUrlFilterCaseSensitive:!1,resourceTypes:A}}]].flat().filter(Boolean).map((e,o)=>({id:o+1+2e3,...e})),z=()=>{N.length&&chrome.declarativeNetRequest.getDynamicRules(e=>{chrome.declarativeNetRequest.updateDynamicRules({removeRuleIds:[...new Set([...N.map(o=>o.id),...e.map(o=>o.id)])],addRules:N})})};$();chrome.runtime.onInstalled.addListener(e=>{z()});var X=E?T:"https://github.com/ha0z1/New-Bing-Anywhere/blob/main/uninstall.md";chrome.runtime.setUninstallURL(X);})();
