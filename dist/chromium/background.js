"use strict";(()=>{var c="https://www.bing.com/",R="https://cn.bing.com/",N=["zh-CN","ru","ru-ru"],x="113",v="113.0.1774.57",P=["csp_report","font","image","main_frame","media","object","other","ping","script","stylesheet","sub_frame","webbundle","websocket","webtransport","xmlhttprequest"];var C="2.0.0";var h={type:"git",url:"https://github.com/haozi/New-Bing-Anywhere"};var K=()=>chrome.i18n.getUILanguage().toLowerCase()==="zh-cn",V=()=>{let e=chrome.i18n.getUILanguage().toLowerCase();return e==="zh-cn"||e==="zh-tw"||e==="zh-hk"||e==="zh"};var E=e=>{chrome.runtime.onMessage.addListener((t,r,n)=>((async()=>{try{let{method:o,args:s}=t,i=await e[o](...s);n({code:200,msg:"ok",data:i})}catch(o){let s=o??{};n({code:500,msg:s.stack??s.message??o})}})(),!0))};var le=(()=>{let e="v1";return{get:async t=>{t=`${e}:${t}`;let{data:r,maxAge:n,lastModified:o}=(await chrome.storage.local.get(t))?.[t]??{};return Date.now()-o>n*1e3?(chrome.storage.local.remove(t),null):r},set:async(t,r,n=1/0)=>{t=`${e}:${t}`,await chrome.storage.local.set({[t]:{data:r,lastModified:Date.now(),maxAge:n}})}}})();var f=navigator.userAgent,Y=f.includes("Macintosh"),ue=f.includes("Firefox"),J=f.includes("Edg/"),T=V(),L=K(),w=!!globalThis.__NBA_isCanary,g=w?`0.${C}`:C,U=()=>{let e=f;return J||(Y?e=`Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/${x}.0.0.0 Safari/537.36 Edg/${v}`:e=`Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/${x}.0.0.0 Safari/537.36 Edg/${v}`),e},_=async()=>{let r=`${h.url}/issues/new?title=&body=`,n="Please write your comment ABOVE this line, provide as much detailed information and screenshots as possible.The UA may not necessarily reflect your actual browser and platform, so please make sure to indicate them clearly.";T&&(n="\u8BF7\u5728\u6B64\u884C\u4E0A\u65B9\u53D1\u8868\u60A8\u7684\u8BA8\u8BBA\u3002\u8BE6\u5C3D\u7684\u63CF\u8FF0\u548C\u622A\u56FE\u6709\u52A9\u4E8E\u6211\u4EEC\u5B9A\u4F4D\u95EE\u9898\uFF0CUA \u4E0D\u4E00\u5B9A\u771F\u5B9E\u53CD\u6620\u60A8\u7684\u6D4F\u89C8\u5668\u548C\u5E73\u53F0\uFF0C\u8BF7\u5907\u6CE8\u6E05\u695A");let o=` 



<!--  ${n} -->
Version: ${g}${w?" (Canary)":""} 
UA: ${navigator.userAgent}
Lang: ${chrome.i18n.getUILanguage()}
AcceptLangs: ${(await chrome.i18n.getAcceptLanguages()).join(", ")}`;return r+=encodeURIComponent(o.slice(0,2e3)),r};var m=(e="",t)=>{try{return new URL(e,t)}catch{return{searchParams:{get:()=>null}}}},I=e=>{try{return new URLSearchParams(e)}catch{return{get:()=>null}}},a=async e=>{let t=await chrome.tabs.query({currentWindow:!0}),r=m(e),n=t.find(o=>o.url?.startsWith(r.origin));return n==null?n=await chrome.tabs.create({url:e}):await Promise.all([chrome.tabs.move(n.id,{index:t.length-1}),n.url!==e&&chrome.tabs.update(n.id,{url:e}),chrome.tabs.update(n.id,{active:!0,url:n.url!==e?e:void 0})].filter(Boolean)),n},y=async(e,t={})=>await chrome.cookies.set({domain:t.domain,storeId:t.storeId,path:t.path,httpOnly:t.httpOnly,secure:t.secure,sameSite:t.sameSite,expirationDate:t.expirationDate,...e});var k={openChat:{title:"\u{1F4AC} New Bing",contexts:["action"],onclick:e=>{a("https://www.bing.com/search?q=Bing+AI&showconv=1")}},openImageCreate:{title:"\u{1F5BC}\uFE0F New Bing Image Creator",contexts:["action"],onclick:e=>{a("https://www.bing.com/create")}},likeIt:{title:"\u2764\uFE0F Like it",contexts:["action"],onclick:()=>{a("https://chrome.google.com/webstore/detail/new-bing-anywhere/hceobhjokpdbogjkplmfjeomkeckkngi/reviews")}},reportIssues:{title:T?"\u{1F41B} \u53CD\u9988\u5EFA\u8BAE":"\u{1F41B} Report issues",contexts:["action"],onclick:async e=>{let t=await _();a(t)}}},B=()=>{chrome.contextMenus.removeAll(()=>{for(let[e,t]of Object.entries(k))chrome.contextMenus.create({id:e,title:t.title,contexts:t.contexts})}),chrome.contextMenus.onClicked.addListener((e,t)=>{let{menuItemId:r}=e,n=k[r];n?.onclick&&n.onclick(e,t)})};var p="notification",b="notification:hide",Q=async()=>{let e;try{e=await fetch("https://api.github.com/repos/haozi/New-Bing-Anywhere/issues/24").then(async t=>await t.json())}catch{}return e},M=async()=>{let{[p]:e}=await chrome.storage.local.get(p);if(!e||e.lastModify&&Date.now()-e.lastModify>36e5){await chrome.storage.local.remove(p);let n=await Q();n&&await chrome.storage.local.set({[p]:{data:n,lastModify:Date.now()}})}let{[b]:t,[p]:r}=await chrome.storage.local.get([b,p]);return!r?.data||!(r.data.title&&r.data.state==="open")||t===1&&r.data.title===e.data?.title?null:(await chrome.storage.local.remove(b),r.data)},q=async()=>{chrome.storage.local.set({[b]:1})};var l={},X=0,Z=()=>++X,O=async()=>{let e=await fetch("https://www.bing.com/turing/conversation/create",{headers:{accept:"*/*","accept-language":"zh,en;q=0.9,en-US;q=0.8,zh-CN;q=0.7,zh-TW;q=0.6","sec-fetch-dest":"empty","sec-fetch-mode":"cors","sec-fetch-site":"none"},referrerPolicy:"strict-origin-when-cross-origin",body:null,method:"GET",mode:"cors",credentials:"include"}).then(async t=>await t.json());return{conversationId:e.conversationId,clientId:e.clientId,conversationSignature:e.conversationSignature}},D=async()=>{let e="wss://sydney.bing.com/sydney/ChatHub";return await new Promise((t,r)=>{let n=new WebSocket(e),o=Z();n.onopen=s=>{let i=JSON.stringify({protocol:"json",version:1})+"";n.send(i)},n.onclose=()=>{console.log("WebSocket is closed"),l[o]=null},n.onmessage=s=>{if(s.data==="{}"){l[o]=n,t(o);return}n.close(),l[o]=null,r(new Error("WebSocket did not connect successfully"))}})},$=async(e,t)=>await new Promise((r,n)=>{let o=l[e];if(o==null)throw new Error(`WebSocket ${e} not found`);o.send(JSON.stringify({type:6})+""),r(null)}),j=async(e,t)=>await new Promise((r,n)=>{let o=l[e];if(o==null)throw new Error(`WebSocket ${e} not found`);o.onmessage=s=>{let i=s.data;for(let d of i.split("").filter(Boolean)){let u=JSON.parse(d.replaceAll(`
`,"\\n"));chrome.runtime.sendMessage({method:"bingChatSendOnMessage",data:u},()=>{}),u.type===2&&setTimeout(()=>{r(u)})}},o.send(JSON.stringify(t)+"")}),G=async e=>{l[e]?.close(),l[e]=null};var ee=async()=>({version:g}),te=async({url:e}={})=>{let t=await chrome.tabs.query({currentWindow:!0}),r=m(e),n=t.find(F=>F.url?.startsWith(r.origin));n==null?n=await chrome.tabs.create({url:e}):n.id!=null&&await Promise.all([chrome.tabs.move(n.id,{index:t.length-1}),chrome.tabs.update(n.id,{active:!0})]);let o=e,s="",i="",d=r.hostname==="www.google.com",u=r.hostname==="www.bing.com";d?(s=r.searchParams.get("q")??"",i=m(n.url).searchParams.get("q")??"",m(n.url).searchParams.get("q")):u&&(s=r.searchParams.get("q")??"",i=m(n.url).searchParams.get("q")??""),s=s.trim(),i=i.trim(),!(s&&s===i)&&(d?o=`${r.origin}${r.pathname}?q=${encodeURIComponent(s)}`:u&&(o=`${r.origin}${r.pathname}?q=${encodeURIComponent(s)}`),await chrome.tabs.update(n.id,{url:o}))},z={getEnv:ee,openUrlInSameTab:te,getNotification:M,hideNotification:q,bingChatCreate:O,bingChatSend:j,bingChatPing:$,bingChatGetSocketId:D,bingChatCloseWebSocket:G};var W=()=>{B(),E(z),chrome.runtime.onInstalled.addListener(e=>{let t=h.url;if(w){a(`${t}/tree/canary`);return}e.reason==="install"?a(t):e.reason==="update"&&a(`${t}/releases/tag/v${g}`)}),chrome.webRequest.onBeforeRequest.addListener(()=>{chrome.cookies.get({name:"_EDGE_S",url:c},e=>{let t=e?.value;if(!t)return;let r=I(t),n=r.get("mkt")?.toLowerCase()??"";N.map(o=>o.toLowerCase()).includes(n)&&(n==="zh-cn"?(r.set("mkt","zh-HK"),r.set("ui","zh-hans")):r.delete("mkt"),y({url:c,name:e.name,value:r.toString()},e))}),chrome.cookies.get({name:"_RwBf",url:c},e=>{let t=e?.value;if(!t){y({url:c,name:"_RwBf",value:"wls=2",domain:".bing.com",httpOnly:!0});return}let r=I(t),n=r.get("wls");n!=="2"&&n!==""&&r.set("wls","2"),y({url:c,name:"_RwBf",domain:".bing.com",httpOnly:!0,value:r.toString()},e)})},{urls:[c+"*"],types:["main_frame"]})};var ne={"User-Agent":U()},re="modifyHeaders",oe="set",S=[{priority:2001,action:{type:re,requestHeaders:Object.entries(ne).map(([e,t])=>({operation:oe,header:e,value:t}))},condition:{requestDomains:["bing.com","www.bing.com","cn.bing.com"],resourceTypes:P}}].filter(Boolean).map((e,t)=>({id:t+1+2e3,...e})),H=()=>{S.length&&chrome.declarativeNetRequest.getDynamicRules(e=>{chrome.declarativeNetRequest.updateDynamicRules({removeRuleIds:[...new Set([...S.map(t=>t.id),...e.map(t=>t.id)])],addRules:S})})};W();chrome.runtime.onInstalled.addListener(e=>{H()});L&&chrome.runtime.setUninstallURL(R);})();
