"use strict";(()=>{var a="https://www.bing.com/";var E=["zh-CN","ru","ru-ru"],m="113",l="113.0.1774.57",u=["csp_report","font","image","main_frame","media","object","other","ping","script","stylesheet","sub_frame","webbundle","websocket","webtransport","xmlhttprequest"];var A="modifyHeaders",b="redirect",J="append",f="set",q=[{action:{type:A,requestHeaders:[{operation:f,header:"sec-ch-ua",value:`"Microsoft Edge";v="${m}", "Chromium";v="${m}", "Not-A.Brand";v="24"`},{operation:f,header:"sec-ch-ua-full-version",value:`"${l}"`},{operation:f,header:"sec-ch-ua-full-version-list",value:`"Microsoft Edge";v="${l}", "Chromium";v="113.0.5672.127", "Not-A.Brand";v="24.0.0.0"`},{operation:f,header:"sec-ms-gec-version",value:`1-${l}`},{operation:f,header:"User-Agent",value:`Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/${m}.0.0.0 Safari/537.36 Edg/${l}`}]},condition:{requestDomains:["bing.com","www.bing.com","cn.bing.com"],resourceTypes:u}},{action:{type:b,redirect:{regexSubstitution:"\\1setlang=zh-Hans&mkt=zh-HK\\2"}},condition:{regexFilter:"(^https:\\/\\/www\\.bing\\.com\\/(?:search|\\?|account/action).*?)(?:mkt=zh-CN|cc=cn|cc=zh-cn|cc=zh)(.*)",isUrlFilterCaseSensitive:!1,requestDomains:["www.bing.com"],resourceTypes:u}},{action:{type:b,redirect:{regexSubstitution:"\\1setlang=ru&cc=clean&mkt=en-us\\2"}},condition:{regexFilter:"(^https:\\/\\/www\\.bing\\.com\\/(?:search|\\?|account/action).*?)(?:mkt=ru-ru|mkt=ru|cc=ru)(.*)",isUrlFilterCaseSensitive:!1,requestDomains:["www.bing.com"],resourceTypes:u}},{action:{type:b,redirect:{url:`${a}?setlang=zh-Hans&mkt=zh-HK`}},condition:{regexFilter:"\\/\\?(?:new-bing-anywhere|nba|run)",isUrlFilterCaseSensitive:!1,requestDomains:["www.bing.com"],resourceTypes:u}},{priority:99,action:{type:b,redirect:{regexSubstitution:`${a}\\1`}},condition:{requestDomains:["cn.bing.com","bing.com"],regexFilter:"^http(?:s)?:\\/\\/(?:cn\\.)?bing\\.com\\/(.*)",resourceTypes:u}},{action:{type:A,responseHeaders:[{header:"Set-Cookie",operation:J,value:"SNRHOP=I=8; domain=.bing.com; path=/; secure; SameSite=None; HttpOnly;"}]},condition:{requestDomains:["bing.com","www.bing.com"]}}].map((e,t)=>({id:t+1,...e}));var T="2.0.0";var x={type:"git",url:"https://github.com/haozi/New-Bing-Anywhere"};var X=()=>chrome.i18n.getUILanguage().toLowerCase()==="zh-cn",Q=()=>{let e=chrome.i18n.getUILanguage().toLowerCase();return e==="zh-cn"||e==="zh-tw"||e==="zh-hk"||e==="zh"};var P=e=>{chrome.runtime.onMessage.addListener((t,r,n)=>((async()=>{try{let{method:o,args:s}=t,i=await e[o](...s);n({code:200,msg:"ok",data:i})}catch(o){let s=o??{};n({code:500,msg:s.stack??s.message??o})}})(),!0))};var we=(()=>{let e="v1";return{get:async t=>{t=`${e}:${t}`;let{data:r,maxAge:n,lastModified:o}=(await chrome.storage.local.get(t))?.[t]??{};return Date.now()-o>n*1e3?(chrome.storage.local.remove(t),null):r},set:async(t,r,n=1/0)=>{t=`${e}:${t}`,await chrome.storage.local.set({[t]:{data:r,lastModified:Date.now(),maxAge:n}})}}})();var v=navigator.userAgent,Z=v.includes("Macintosh"),ye=v.includes("Firefox"),ee=v.includes("Edg/"),N=Q(),be=X(),C=!!globalThis.__NBA_isCanary,w=C?`0.${T}`:T,L=()=>{let e=v;return ee||(Z?e=`Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/${m}.0.0.0 Safari/537.36 Edg/${l}`:e=`Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/${m}.0.0.0 Safari/537.36 Edg/${l}`),e},_=async()=>{let r=`${x.url}/issues/new?title=&body=`,n="Please write your comment ABOVE this line, provide as much detailed information and screenshots as possible.The UA may not necessarily reflect your actual browser and platform, so please make sure to indicate them clearly.";N&&(n="\u8BF7\u5728\u6B64\u884C\u4E0A\u65B9\u53D1\u8868\u60A8\u7684\u8BA8\u8BBA\u3002\u8BE6\u5C3D\u7684\u63CF\u8FF0\u548C\u622A\u56FE\u6709\u52A9\u4E8E\u6211\u4EEC\u5B9A\u4F4D\u95EE\u9898\uFF0CUA \u4E0D\u4E00\u5B9A\u771F\u5B9E\u53CD\u6620\u60A8\u7684\u6D4F\u89C8\u5668\u548C\u5E73\u53F0\uFF0C\u8BF7\u5907\u6CE8\u6E05\u695A");let o=` 



<!--  ${n} -->
Version: ${w}${C?" (Canary)":""} 
UA: ${navigator.userAgent}
Lang: ${chrome.i18n.getUILanguage()}
AcceptLangs: ${(await chrome.i18n.getAcceptLanguages()).join(", ")}`;return r+=encodeURIComponent(o.slice(0,2e3)),r};var g=(e="",t)=>{try{return new URL(e,t)}catch{return{searchParams:{get:()=>null}}}},I=e=>{try{return new URLSearchParams(e)}catch{return{get:()=>null}}},c=async e=>{let t=await chrome.tabs.query({currentWindow:!0}),r=g(e),n=t.find(o=>o.url?.startsWith(r.origin));return n==null?n=await chrome.tabs.create({url:e}):await Promise.all([chrome.tabs.move(n.id,{index:t.length-1}),n.url!==e&&chrome.tabs.update(n.id,{url:e}),chrome.tabs.update(n.id,{active:!0,url:n.url!==e?e:void 0})].filter(Boolean)),n},R=async(e,t={})=>await chrome.cookies.set({domain:t.domain,storeId:t.storeId,path:t.path,httpOnly:t.httpOnly,secure:t.secure,sameSite:t.sameSite,expirationDate:t.expirationDate,...e});var H={openChat:{title:"\u{1F4AC} New Bing",contexts:["action"],onclick:e=>{c("https://www.bing.com/search?q=Bing+AI&showconv=1")}},openImageCreate:{title:"\u{1F5BC}\uFE0F New Bing Image Creator",contexts:["action"],onclick:e=>{c("https://www.bing.com/create")}},likeIt:{title:"\u2764\uFE0F Like it",contexts:["action"],onclick:()=>{c("https://chrome.google.com/webstore/detail/new-bing-anywhere/hceobhjokpdbogjkplmfjeomkeckkngi/reviews")}},reportIssues:{title:N?"\u{1F41B} \u53CD\u9988\u5EFA\u8BAE":"\u{1F41B} Report issues",contexts:["action"],onclick:async e=>{let t=await _();c(t)}}},U=()=>{chrome.contextMenus.removeAll(()=>{for(let[e,t]of Object.entries(H))chrome.contextMenus.create({id:e,title:t.title,contexts:t.contexts})}),chrome.contextMenus.onClicked.addListener((e,t)=>{let{menuItemId:r}=e,n=H[r];n?.onclick&&n.onclick(e,t)})};var h="notification",S="notification:hide",te=async()=>{let e;try{e=await fetch("https://api.github.com/repos/haozi/New-Bing-Anywhere/issues/24").then(async t=>await t.json())}catch{}return e},M=async()=>{let{[h]:e}=await chrome.storage.local.get(h);if(!e||e.lastModify&&Date.now()-e.lastModify>36e5){await chrome.storage.local.remove(h);let n=await te();n&&await chrome.storage.local.set({[h]:{data:n,lastModify:Date.now()}})}let{[S]:t,[h]:r}=await chrome.storage.local.get([S,h]);return!r?.data||!(r.data.title&&r.data.state==="open")||t===1&&r.data.title===e.data?.title?null:(await chrome.storage.local.remove(S),r.data)},D=async()=>{chrome.storage.local.set({[S]:1})};var d={},ne=0,re=()=>++ne,B=async()=>{let e=await fetch("https://www.bing.com/turing/conversation/create",{headers:{accept:"*/*","accept-language":"zh,en;q=0.9,en-US;q=0.8,zh-CN;q=0.7,zh-TW;q=0.6","sec-fetch-dest":"empty","sec-fetch-mode":"cors","sec-fetch-site":"none"},referrerPolicy:"strict-origin-when-cross-origin",body:null,method:"GET",mode:"cors",credentials:"include"}).then(async t=>await t.json());return{conversationId:e.conversationId,clientId:e.clientId,conversationSignature:e.conversationSignature}},O=async()=>{let e="wss://sydney.bing.com/sydney/ChatHub";return await new Promise((t,r)=>{let n=new WebSocket(e),o=re();n.onopen=s=>{let i=JSON.stringify({protocol:"json",version:1})+"";n.send(i)},n.onclose=()=>{console.log("WebSocket is closed"),d[o]=null},n.onmessage=s=>{if(s.data==="{}"){d[o]=n,t(o);return}n.close(),d[o]=null,r(new Error("WebSocket did not connect successfully"))}})},$=async(e,t)=>await new Promise((r,n)=>{let o=d[e];if(o==null)throw new Error(`WebSocket ${e} not found`);o.send(JSON.stringify({type:6})+""),r(null)}),z=async(e,t)=>await new Promise((r,n)=>{let o=d[e];if(o==null)throw new Error(`WebSocket ${e} not found`);o.onmessage=s=>{let i=s.data;for(let y of i.split("").filter(Boolean)){let p=JSON.parse(y.replaceAll(`
`,"\\n"));chrome.runtime.sendMessage({method:"bingChatSendOnMessage",data:p},()=>{}),p.type===2&&setTimeout(()=>{r(p)})}},o.send(JSON.stringify(t)+"")}),j=async e=>{d[e]?.close(),d[e]=null};var oe=async()=>({version:w}),se=async({url:e}={})=>{let t=await chrome.tabs.query({currentWindow:!0}),r=g(e),n=t.find(V=>V.url?.startsWith(r.origin));n==null?n=await chrome.tabs.create({url:e}):n.id!=null&&await Promise.all([chrome.tabs.move(n.id,{index:t.length-1}),chrome.tabs.update(n.id,{active:!0})]);let o=e,s="",i="",y=r.hostname==="www.google.com",p=r.hostname==="www.bing.com";y?(s=r.searchParams.get("q")??"",i=g(n.url).searchParams.get("q")??"",g(n.url).searchParams.get("q")):p&&(s=r.searchParams.get("q")??"",i=g(n.url).searchParams.get("q")??""),s=s.trim(),i=i.trim(),!(s&&s===i)&&(y?o=`${r.origin}${r.pathname}?q=${encodeURIComponent(s)}`:p&&(o=`${r.origin}${r.pathname}?q=${encodeURIComponent(s)}`),await chrome.tabs.update(n.id,{url:o}))},F={getEnv:oe,openUrlInSameTab:se,getNotification:M,hideNotification:D,bingChatCreate:B,bingChatSend:z,bingChatPing:$,bingChatGetSocketId:O,bingChatCloseWebSocket:j};var G=()=>{U(),P(F),chrome.runtime.onInstalled.addListener(e=>{let t=x.url;if(C){c(`${t}/tree/canary`);return}e.reason==="install"?c(t):e.reason==="update"&&c(`${t}/releases/tag/v${w}`)}),chrome.webRequest.onBeforeRequest.addListener(()=>{chrome.cookies.get({name:"_EDGE_S",url:a},e=>{let t=e?.value;if(!t)return;let r=I(t),n=r.get("mkt")?.toLowerCase()??"";E.map(o=>o.toLowerCase()).includes(n)&&(n==="zh-cn"?(r.set("mkt","zh-HK"),r.set("ui","zh-hans")):r.delete("mkt"),R({url:a,name:e.name,value:r.toString()},e))}),chrome.cookies.get({name:"_RwBf",url:a},e=>{let t=e?.value;if(!t){R({url:a,name:"_RwBf",value:"wls=2",domain:".bing.com",httpOnly:!0});return}let r=I(t),n=r.get("wls");n!=="2"&&n!==""&&r.set("wls","2"),R({url:a,name:"_RwBf",domain:".bing.com",httpOnly:!0,value:r.toString()},e)})},{urls:[a+"*"],types:["main_frame"]})};var ie={"User-Agent":L()},ae="modifyHeaders",ce="set",W=[{priority:2001,action:{type:ae,requestHeaders:Object.entries(ie).map(([e,t])=>({operation:ce,header:e,value:t}))},condition:{requestDomains:["bing.com","www.bing.com","cn.bing.com"],resourceTypes:u}}].filter(Boolean).map((e,t)=>({id:t+1+2e3,...e}));var K=chrome,Y=[...q,...W],le=Y.filter(e=>e.action?.type==="modifyHeaders"&&e.action?.requestHeaders?.length),ue=Y.filter(e=>e.action?.type==="modifyHeaders"&&e.action?.responseHeaders?.length);G();K.webRequest.onBeforeSendHeaders.addListener(e=>{if(!e.requestHeaders)return;let t=e.requestHeaders;for(let r of le){let n=new URL(e.url);if(!r.condition||(r.condition?.requestDomains??[]).includes(n.hostname)||new RegExp(r.condition?.regexFilter??"",r.condition?.isUrlFilterCaseSensitive?"i":void 0).test(n.href)||n.href.includes(r.condition?.urlFilter??""))for(let o of r.action.requestHeaders??[])switch(o.operation){case"set":if(!e.requestHeaders.find(s=>s.name===o.header))t.push({name:o.header,value:o.value});else for(let s of e.requestHeaders)s.name.toLowerCase()===o.header.toLowerCase()&&(s.value=o.value);break;case"append":t.push({name:o.header,value:o.value});break;case"remove":{let s=t.findIndex(i=>i.name.toLowerCase()===o.header.toLowerCase());s>-1&&t.splice(s,1)}break;default:}}return{requestHeaders:t}},{urls:["<all_urls>"]},["blocking","requestHeaders"]);K.webRequest.onHeadersReceived.addListener(e=>{if(!e.responseHeaders)return;let t=e.responseHeaders;for(let r of ue)if(new RegExp(r.condition?.regexFilter??"",r.condition?.isUrlFilterCaseSensitive?"i":void 0).test(e.url))for(let n of r.action.responseHeaders??[])switch(n.operation){case"set":for(let o of e.responseHeaders)o.name.toLowerCase()===n.header.toLowerCase()?o.value=n.value:t.push({name:n.header,value:n.value});break;case"append":t.push({name:n.header,value:n.value});break;default:}return{responseHeaders:t}},{urls:["<all_urls>"]},["blocking","responseHeaders"]);})();
